{%load static%}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Checkout page</title>
    <link href="{%static 'css/checkout.css'%}" rel="stylesheet" type="text/css" media="all" />
    <meta name="keywords"
        content="Mobilestore iphone web template, Android web template, Smartphone web template, free webdesigns for Nokia, Samsung, LG, Sony Ericsson, Motorola web design" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
     
      </head>

<body>
    <div class="container mt-3 ml-1">
      <form action="orderplaced" method="post"> 
        {%csrf_token%}
      <div class="row">
        <div class="col-md-6 ">
          <div class="card shadow ">
            <div class="card-body">
              <h3>Customer Details</h3><hr>
              <div class="row checkoutform">
                
                <div class="col-md-12">
                  <label for="name">*FullName</label>
                  <input required  type="text" class="form-control" id="name" name="c_name" placeholder="Enter Your Fullname">
  
                </div>
                <div class="col-md-6 mt-2">
                  <label for="email">*Email</label>
                  <input required  type="email" class="form-control" id="email" name="c_email" placeholder="Enter Your Valid Email">
  
                </div>
                <div class="col-md-6 mt-2">
                  <label for="mobile">*Mobile No.</label>
                  <input required  type="tel" class="form-control" id="mobile" name="c_mobile" placeholder="Enter Your Mobile No">
        
                </div>
                
                
                <div class="col-md-12 mt-2">
                  <label for="address">*Address</label>
                  <input required  type="text" class="form-control" id="address" name="address" placeholder="1234 Main St">
        
                </div>
                <div class="col-md-12 mt-2">
                  <label for="address2">*Address 2</label>
                  <input required type="text" class="form-control" id="address2" name="address2" placeholder="Landmark">
        
                </div>
                <div class="col-md-6 mt-2">
                  <label for="city">*City</label>
                  <input required  type="text" class="form-control " id="city" name="city"placeholder="Enter Your City">
      
                </div>
                <div class="col-md-6 mt-2">
                  <label for="State">*State</label>
                  <input required type="text" class="form-control" id="state" name="state"   placeholder="Enter Your State">
      
                </div>
                <div class=" col-md-6 mt-2">
                  <label for="pincode">*Zip</label>
                  <input required type="text" class="form-control" id="pincode" name="zipcode" placeholder="e.g,123456">
                </div>
                <input type="hidden" value="{{total}}" id="amount" name="amount"></input>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 ">
          <div class="card shadow">
            <div class="card-body">
              <h3>Order Summary</h3><hr>
                {%if item%}
                <table class="table table-stripeds table-bordereds">
                  <thead>
                    <tr>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Quantity</th>
                      <th>Price</th>
                    </tr>

                  </thead>
                  <tbody>
                    {%for i in allcart%}
                    <tr>
                      <td>
                        <a href="productdetails?id={{i.productid_id}}">
                          <img src="pimage/{{i.productimage1}}" width="70px" height="70px">
                        </a>
                        </td>
                      <td>
                        <a href="productdetails?id={{i.productid_id}}" class="text-decoration-none text-black">{{i.productname | truncatewords:5}}</a>
                      </td>
                      <td>{{i.productqty}}</td>
                      <td>{{i.productprice}}.00</td>
                    </tr>
                    {%endfor%}
                  </tbody>

                </table>
                <h4 class="fw-bold ">Grand Total
                  <span class="float-end mr-2 text-danger">{{total}}.00/-</span>
                </h4>
                <input type="hidden" name="payment_mode"></input>
                <div class="mt-3">
                  <button type="submit"  class="btn btn-success w-100 cod">COD | Place Order</button>
                  <h5 class="mt-2">Payment Choices:</h5>
                  <button type="button"  class="btn btn-dark w-100 RazorPay" id="rzp-button1">Pay With RazorPay</button>

                </div>
                {%else%}
                <center><h6>Your Cart is Empty</h6></center>
                {%endif%}
            </div>
          </div>
        </div>
      </form>
      </div>
    </div>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script
src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  jQuery(document).on('click', '.cod', function (e) { 
    e.preventDefault();
    
  var total_amount = $('#amount').val();
     //alert(total_amount);
     var cname = $('#name').val();
     var mobile = $('#mobile').val();
     var email = $('#email').val();
     var address = $('#address').val();
     var address2 = $('#address2').val();
     var city = $('#city').val();
     var state = $('#state').val();
     var pincode = $('#pincode').val();
     function isEmail(email) {
       var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
       return regex.test(email);
     }
    
     if (cname =="" | email =="" | mobile=="" | address =="" | address2==""|city==""|state==""|pincode=="")
     {
         swal("Alert!", "All the fields are mandatory!","error");
         
     }
     else if(isEmail(email)==false){
       swal("Alert!", "Email is not valid!","error");
       
     }
     else if($.isNumeric(mobile)==false){
       swal("Alert!", "phone Number must be numbers !","error");
       
     }
 
   
     else if($.isNumeric(pincode)==false){
       swal("Alert!", "pincode must be numbers !","error");
       
     }
   
  else{
       $.ajax({
       method:"POST",
       headers: {'X-CSRFToken': csrftoken},
       url: "http://127.0.0.1:8000/orderplaced",
       data: {"c_name":cname,     
               "c_email":email,
               "c_mobile":mobile,
               "address":address,
               "address2":address2,
               "city":city,
               "state":state,
               "zipcode":pincode,
                "amount":total_amount,
               "payment_mode":"COD"},
            	success:function(){
                swal("Congratulations!!", "your order has been placed successfully","success").then(()=>{
                  window.location.href='http://127.0.0.1:8000/index'
                });
              }
      
 });
 
}

});
 
   jQuery(document).on('click', '#rzp-button1', function (e) { 
     e.preventDefault();
     
	 var total_amount = $('#amount').val();
			//alert(total_amount);
			var cname = $('#name').val();
			var mobile = $('#mobile').val();
			var email = $('#email').val();
			var address = $('#address').val();
			var address2 = $('#address2').val();
			var city = $('#city').val();
			var state = $('#state').val();
			var pincode = $('#pincode').val();
			function isEmail(email) {
        var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
        return regex.test(email);
      }
     
      if (cname =="" | email =="" | mobile=="" | address =="" | address2==""|city==""|state==""|pincode=="")
      {
          swal("Alert!", "All the fields are mandatory!","error");
          
      }
      else if(isEmail(email)==false){
        swal("Alert!", "Email is not valid!","error");
        
      }
      else if($.isNumeric(mobile)==false){
        swal("Alert!", "phone Number must be numbers !","error");
        
      }
  
    
      else if($.isNumeric(pincode)==false){
        swal("Alert!", "pincode must be numbers !","error");
        
      }
    
   else{
	// alert(paymenttype);
	
	 //alert("inside online");

	var totalAmount = total_amount*100;

    var merchant_total = totalAmount;
    
    var merchant_order_id = "123";
    var currency_code_id = "INR";
     var options = {
    "key": "rzp_test_JjctKLxiA3zHAO",
    "amount": merchant_total, // 2000 paise = INR 20
    "name": "Apna Store",
    "description": "Order & Payment confirmation from Apna  Store",

    "currency" : "INR",
    "netbanking" : true,
    prefill: {
            name: cname,
           email: email,
            contact: mobile,

        },
    notes: {
            soolegal_order_id: merchant_order_id,
        },
   
      
    "handler": function (response){
    	  	//alert("inside ajax");
			 //window.location.href = 'http://127.0.0.1:8000/home';
			  //   window.location = res.redirectURL;
              
			  $.ajax({
				method:"POST",
				headers: {'X-CSRFToken': csrftoken},
				url: "http://127.0.0.1:8000/orderplaced",
				data: {"c_name":cname,     
                "c_email":email,
                "c_mobile":mobile,
                "address":address,
                "address2":address2,
                "city":city,
                "state":state,
                "zipcode":pincode,
							   "amount":total_amount,
                "payment_mode":"Paid by RazorPay",
                "payment_id":response.razorpay_payment_id},
				
					success: function(data){
            swal("Congratulations!!", "your order has been placed successfully","success").then(()=>{
              window.location.href='http://127.0.0.1:8000/index'
          });
				}});	
			 
    },

    "theme": {
        "color": "#528FF0"
    }
  };
  
}
  var rzp1 = new Razorpay(options);
  rzp1.open();
  e.preventDefault(); 
});
  
  
</script>
</body>

</html>